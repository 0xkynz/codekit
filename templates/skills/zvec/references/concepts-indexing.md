# Zvec Concepts & Indexing

## Data Modeling

### Collections
Named containers for documents (like database tables). Each has its own schema. Schema is dynamic — add/remove fields without recreating the collection. Each collection persists independently in its own directory.

### Documents
Three components:
- `id` — unique string identifier (immutable after insertion)
- `vectors` — named set of vector embeddings
- `fields` — named set of scalar field values

All documents within a collection conform to the same schema.

### Data Types

**Scalar types:**
- Elementary: STRING, BOOL, INT32, INT64, UINT32, UINT64, FLOAT, DOUBLE
- Arrays: ARRAY_STRING, ARRAY_BOOL, ARRAY_INT32, ARRAY_INT64, ARRAY_UINT32, ARRAY_UINT64, ARRAY_FLOAT, ARRAY_DOUBLE

**Vector types:**
- Dense: VECTOR_FP16, VECTOR_FP32, VECTOR_INT8
- Sparse: SPARSE_VECTOR_FP32, SPARSE_VECTOR_FP16

Type safety is enforced at ingestion. Vectors must match specified dimensionality and type exactly.

### Indexing Rules
- Every vector field **must** be indexed with a vector index
- Scalar fields are **optionally** indexed — add inverted indexes on fields you filter on
- Indexes can be defined at creation or added dynamically via `create_index()`

## Vector Embeddings

Vectors are lists of numbers generated by embedding models to capture semantic essence of unstructured data (text, images, audio). Semantically similar items produce similar vectors.

### Distance Metrics

| Metric | Description |
|--------|-------------|
| **COSINE** | Cosine similarity — angle between vectors |
| **L2** | Euclidean distance |
| **IP** | Inner product (dot product) |

The metric must match what was used during embedding model training.

### Dense Vectors
Fixed-length, real-valued embeddings where nearly every dimension carries semantic information. Example: 384-dim or 768-dim neural network output. Understands context (e.g., "king - man + woman ≈ queen").

### Sparse Vectors
High-dimensional representations where only a subset of dimensions are non-zero. Each dimension maps to specific terms weighted by relevance (e.g., BM25). Similarity via dot product. Interpretable but lacks semantic understanding.

## Vector Index Types

A vector index accelerates similarity search over large collections. Without indexing, search requires brute-force comparison against every vector.

### Recall Metric

`Recall@k = (true nearest neighbors in top-k) / k`

High recall (>=96%) is practically equivalent to exact search.

### Flat Index (Brute-Force)

Exact similarity search — compares query against every vector.

- **Perfect recall** guaranteed
- **Zero configuration** — no tuning needed
- **Instant indexing** — virtually no build time
- **Limitation:** Search latency grows linearly with dataset size

Best for: small datasets, prototyping, evaluation baselines, 100% recall requirements.

```python
zvec.FlatIndexParam(metric_type=zvec.MetricType.COSINE)
```

### HNSW Index (Recommended Default)

Graph-based approximate nearest neighbor search. Multi-layer graph: upper layers for fast navigation, lower layers for fine-grained search.

- Near-logarithmic query time O(log n)
- Consistently high recall
- Faster indexing than IVF
- **Trade-off:** Higher memory footprint

**Index-time parameters:**
| Parameter | Purpose |
|-----------|---------|
| `metric_type` | Distance metric (COSINE, L2, IP) |
| `m` | Max neighbors per node (higher = better recall + more memory) |
| `ef_construction` | Build-time candidate pool (higher = better quality + longer build) |
| `quantize_type` | Vector quantization method |

**Query-time parameters:**
| Parameter | Purpose |
|-----------|---------|
| `ef` | Query candidate pool (higher = better recall + more latency) |
| `radius` | Distance threshold for range filtering |
| `is_linear` | Force brute-force (debugging only) |
| `is_using_refiner` | Exact score refinement for quantized vectors |

**Tuning:** Adjust `ef` first for recall/latency trade-offs before modifying construction parameters.

```python
zvec.HnswIndexParam(
    metric_type=zvec.MetricType.COSINE,
    m=16,
    ef_construction=200,
    quantize_type=zvec.QuantizeType.INT8,
)
```

### IVF Index (Inverted File)

Partition-based indexing. Clusters vectors into `n_list` groups, then searches only `n_probe` nearest clusters.

- Query time ~O(N / n_list * n_probe)
- Memory efficient
- Compatible with Product Quantization (IVF-PQ)
- **Trade-off:** Slower indexing, parameter-sensitive

**Parameters:**
| Parameter | Purpose | Guidance |
|-----------|---------|----------|
| `n_list` | Number of clusters | Start with sqrt(N) |
| `n_iters` | Centroid refinement passes | Higher = better clustering, longer build |
| `n_probe` | Query-time clusters searched | Higher = better recall, slower queries |

```python
zvec.IVFIndexParam(
    metric_type=zvec.MetricType.COSINE,
    n_list=1024,
    n_iters=10,
)
```

## Quantization

Lossy compression transforming FP32 vectors into compact representations. Reduces memory footprint and query latency at the cost of recall accuracy.

Zvec maintains both original and quantized copies. Only quantized vectors are loaded into memory for indexing/search. Originals remain retrievable.

| Type | Description | Use Case |
|------|-------------|----------|
| **FP16** | 16-bit floating point | Near-FP32 accuracy, improved efficiency |
| **INT8** | 8-bit integer | Balanced speed, size, and accuracy |
| **INT4** | 4-bit integer | Ultra-compact, maximum density |

Enable via `quantize_type` when creating vector indexes:
```python
zvec.HnswIndexParam(
    metric_type=zvec.MetricType.COSINE,
    quantize_type=zvec.QuantizeType.INT8,
)
```

## Inverted Index (Scalar Fields)

Maps field values to document lists for fast filtering and keyword matching.

Best for:
- Exact-value filtering: `status = "active"`
- Range queries: `age > 25`
- Text patterns: `product_name LIKE "Wireless%"`
- Array membership: `tags CONTAIN_ANY ["sport", "music"]`

**Trade-offs:**
- Additional storage overhead
- Write amplification (every insert/upsert/update maintains the index)

```python
zvec.FieldSchema(
    name="category",
    data_type=zvec.DataType.ARRAY_STRING,
    index_param=zvec.InvertIndexParam(),
)
```
